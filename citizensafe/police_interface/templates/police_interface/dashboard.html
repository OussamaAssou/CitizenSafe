{% extends 'base.html' %}

{% block title %}Tableau de bord police{% endblock %}

{% block page_title %}Tableau de bord police{% endblock %}

{% block content %}
<!-- Bouton pour changer le statut de service -->
<div class="row mb-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-body">
        <form method="post" action="{% url 'police:toggle_duty' %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-lg btn-block btn-{% if request.user.policeofficer.is_on_duty %}danger{% else %}success{% endif %}">
            {% if request.user.policeofficer.is_on_duty %}
              <i class="ni ni-button-power mr-2"></i>Se mettre hors service
            {% else %}
              <i class="ni ni-check-bold mr-2"></i>Se mettre en service
            {% endif %}
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-xl-6">
    <div class="card">
      <div class="card-header border-0">
        <div class="row align-items-center">
          <div class="col">
            <h3 class="mb-0">Alertes actives</h3>
          </div>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table align-items-center table-flush">
          <thead class="thead-light">
            <tr>
              <th scope="col">Type</th>
              <th scope="col">Citoyen</th>
              <th scope="col">Date</th>
            </tr>
          </thead>
          <tbody>
            {% for alert in active_alerts %}
              <tr>
                <td>{{ alert.get_alert_type_display }}</td>
                <td>
                  {% if alert.citizen %}
                    {{ alert.citizen.last_name|default:""}}{% if alert.citizen.last_name %}.{% endif %} {{ alert.citizen.first_name }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>{{ alert.timestamp|date:"d/m/Y H:i" }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="3">Aucune alerte active.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-xl-6">
    <div class="card">
      <div class="card-header border-0">
        <div class="row align-items-center">
          <div class="col">
            <h3 class="mb-0">Incidents récents</h3>
          </div>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table align-items-center table-flush">
          <thead class="thead-light">
            <tr>
              <th scope="col">Type</th>
              <th scope="col">Lieu</th>
              <th scope="col">Date</th>
            </tr>
          </thead>
          <tbody>
            {% for incident in recent_incidents %}
              <tr>
                <td>{{ incident.get_incident_type_display }}</td>
                <td>{{ incident.location }}</td>
                <td>{{ incident.timestamp|date:"d/m/Y H:i" }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="3">Aucun incident récent.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-lg-6">
    <div class="card">
      <div class="card-body">
        {% if request.user.policeofficer.is_on_duty %}
          <a href="{% url 'police:patrol_optimization' %}" class="btn btn-primary btn-block">
            <i class="ni ni-map-big mr-2"></i>Optimisation des patrouilles
          </a>
        {% else %}
          <button class="btn btn-primary btn-block" disabled title="Vous devez être en service pour optimiser les patrouilles">
            <i class="ni ni-map-big mr-2"></i>Optimisation des patrouilles
          </button>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card">
      <div class="card-body">
        <a href="{% url 'police:create_incident_report' %}" class="btn btn-secondary btn-block">
          <i class="ni ni-single-copy-04 mr-2"></i>Créer un rapport d'incident
        </a>
      </div>
    </div>
  </div>
</div>

{% if messages %}
<div class="row mt-4">
  <div class="col-lg-12">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <span class="alert-icon"><i class="ni ni-like-2"></i></span>
        <span class="alert-text">{{ message }}</span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function() {
    // Pour fermer les alertes
    $(".alert").alert();
  });
</script>
{% endblock %}